<body>
  <button type="button" onclick="onCallbackClicked()">Click to callback</button>
  <button id="platformButton" type="button" onclick="onGetPlatformClicked()">
    Get platform
  </button>
  <text id="log">nothing</text>

  <script>
    function getValue() {
      return 123;
    }

    function onCallbackClicked() {
      call("clickButton", "Click to callback");
    }

    function onGetPlatformClicked() {
      call("getPlatform", null, (platform) => {
        document.getElementById("platformButton").textContent = platform;
      });
    }

    let reqId = 0;
    const requests = {};

    function call(method, data, callback) {
      const message = {
        method,
        requestId: ++reqId,
      };
      if (data) {
        message.data = data;
      }
      requests[message.requestId] = callback;
      invoke(message);
    }

    function invoke(message) {
      // 这个方法由 Native 注入
      window.tapBillboardJS2Native(JSON.stringify(message));
    }

    function handleRequest(message) {
      const result = {
        responseId: message.requestId,
      };
      if (message.method === "getValue") {
        result.data = getValue();
      } else if (message.method === "submit") {
        document.getElementById("log").textContent = "submit";
      }
      invoke(result);
    }

    function handleResponse(message) {
      if (requests[message.responseId]) {
        requests[message.responseId](message.data);
      }
    }

    window.tapBillboardNative2JS = function (json) {
      const message = JSON.parse(json);
      if (message.requestId) {
        // 请求
        handleRequest(message);
      } else if (message.responseId) {
        // 应答
        handleResponse(message);
      } else {
        // 异常消息
      }
    };

    // window.tapBillboardJS2Native = function (message) {
    //   // 空实现，等 Native 注入
    // };
  </script>
</body>
